# Задание 1. Спецификация, алгоритмы, интерфейс, тестирование

## 1) Краткая спецификация разрабатываемого модуля

### 1.1. Наименование
Программный модуль учета заявок на ремонт бытовой техники.

### 1.2. Назначение
Автоматизация обработки заявок на ремонт:

- регистрация новых заявок;
- редактирование заявки (описание, статус, исполнитель, комплектующие);
- поиск и фильтрация заявок;
- фиксация комментариев мастера;
- расчет статистики по работе сервисного отдела;
- управление пользователями и ролями (для Менеджера).

### 1.3. Пользователи и роли (ограничение доступа)

Роли реализованы через справочник `user_role` и проверяются на уровне приложения
(`app/rbac.py`).

- **Менеджер**:
  - просмотр всех заявок;
  - создание/редактирование/удаление заявок;
  - назначение/смена исполнителя;
  - произвольная смена статусов;
  - управление пользователями;
  - доступ к статистике.

- **Оператор**:
  - просмотр всех заявок;
  - создание/редактирование/удаление заявок;
  - назначение исполнителей;
  - смена статусов.

- **Мастер/Специалист**:
  - просмотр только своих заявок (`master_id = текущий пользователь`);
  - редактирование только своих заявок;
  - добавление комментариев;
  - смена статуса своей заявки (без «раскрытия» финального статуса назад);
  - создание запросов помощи.

- **Заказчик**:
  - просмотр только своих заявок (`client_id = текущий пользователь`);
  - создание новых заявок;
  - редактирование своей заявки только до финального статуса;
  - без права менять статус/исполнителя и комплектующие.

- **Менеджер по качеству**:
  - просмотр всех заявок;
  - обработка запросов помощи;
  - продление сроков и назначение исполнителя.

### 1.4. Входные данные (структура)

Источники данных (CSV‑импорт):

- `Users`: userID, fio, phone, login, password, type (роль);
- `Requests`: requestID, startDate, homeTechType, homeTechModel,
  problemDescription, requestStatus, completionDate, dueDate, repairParts,
  masterID, clientID;
- `Comments`: commentID, message, masterID, requestID.

Данные форм (UI):

- логин, пароль;
- поля заявки: дата, тип оборудования, модель, описание проблемы, статус,
  дата завершения, плановый срок, комплектующие, исполнитель, заказчик;
- комментарий мастера;
- данные пользователя (для Менеджера): ФИО, телефон, логин, роль, пароль.

### 1.5. Выходные данные

- список заявок (таблица) с ключевыми полями и действиями;
- карточка заявки (детали + комментарии + QR‑код);
- формы создания/редактирования заявок и пользователей;
- сообщения пользователю (успех/ошибка/предупреждение);
- статистический отчет:
  - количество выполненных заявок,
  - среднее время ремонта,
  - статистика по типам оборудования и неисправностей,
  - нагрузка мастеров.

---

## 2) Основной алгоритм учета заявок (A1)

**Вход:** логин/пароль; действия пользователя (поиск/создание/редактирование/просмотр).
**Выход:** отображение списка/карточки, сохранение данных, сообщения.

1. Пользователь открывает страницу входа.
2. Вводит логин и пароль.
3. Проверка учетных данных:
   - неверно → сообщение об ошибке и возврат к п.2;
   - верно → открыть список заявок.
4. Список фильтруется по роли:
   - Менеджер/Оператор/Менеджер по качеству → все заявки;
   - Мастер → только свои;
   - Заказчик → только свои.
5. Пользователь выбирает действие:
   - поиск/фильтр → обновить список;
   - открыть карточку → показать детали;
   - создать/редактировать → открыть форму и перейти к п.6;
   - удалить → подтверждение и удаление (если разрешено ролью).
6. Валидация формы:
   - обязательные поля заполнены;
   - даты корректные;
   - соблюдены ограничения роли.
7. Сохранение в БД:
   - при ошибке → сообщение;
   - при успехе → уведомление и возврат к списку.

---

## 3) Детализация функции F1: расчет среднего времени ремонта

1. Взять заявки с финальным статусом и заполненной датой завершения.
2. Для каждой заявки вычислить разницу `completion_date - start_date` в днях.
3. Усреднить значения и вернуть результат (если данных нет — `None`).

Реализация — `services.calculate_statistics_from_rows`.

---

## 4) Реализация интерфейса

Реализованы страницы:

- `login.html` — вход;
- `requests.html` — список заявок + фильтры;
- `request_form.html` — создание/редактирование заявки;
- `request_view.html` — карточка заявки + комментарии + QR‑код;
- `statistics.html` — статистика (Менеджер);
- `users.html`, `user_form.html` — управление пользователями;
- `help_request_form.html` — запрос помощи мастера;
- `quality_desk.html` — контроль качества.

Навигация:

- левое меню;
- кнопки «Назад» на формах;
- подтверждение удаления;
- сообщения через `?status=...` и `build_status_messages`.

---

## 5) Тестирование

- `tests/test_statistics.py` — проверка расчёта статистики;
- `tests/test_rbac.py` — проверка прав доступа;
- `tests/test_help_requests.py` — правила запросов помощи.
