# Руководство системному программисту

## 1. Назначение и состав программного обеспечения

Программный модуль «Учет заявок на ремонт бытовой техники» предназначен для регистрации,
обработки и контроля заявок, а также для поддержки взаимодействия между мастерами,
менеджерами и менеджером по качеству.

Технологический стек:

- Backend: Python 3.12, FastAPI, SQLAlchemy 2.x.
- База данных: PostgreSQL 16.
- Веб-интерфейс: Jinja2 + CSS.
- Инфраструктура: Docker, docker-compose.
- Дополнительные компоненты:
  - `qrcode[pil]` — генерация QR‑кодов для перехода к форме оценки качества.

Основные директории проекта:

- `app/` — исходный код приложения:
  - `main.py` — HTTP‑маршруты (FastAPI, HTML‑страницы);
  - `models.py` — ORM‑модели SQLAlchemy;
  - `services.py` — сервисные функции (хеширование паролей, статистика, QR‑ссылки);
  - `rbac.py` — ролевая модель и проверки доступа;
  - `usecases.py` — бизнес‑операции над заявками и запросами помощи;
  - `ui_utils.py` — утилиты обработки форм и статус‑сообщений;
  - `templates/` — HTML‑шаблоны;
  - `static/` — статические ресурсы (CSS, логотипы, иконки).
- `db/` — SQL‑скрипты:
  - `init.sql` — создание схемы БД, таблиц, индексов, триггеров;
  - `reports.sql` — отчётные запросы (VIEW);
  - `security.sql` — пример разграничения доступа на уровне PostgreSQL.
- `scripts/` — инфраструктурные скрипты:
  - `Dockerfile.app`, `Dockerfile.importer`;
  - `requirements.txt` — зависимости;
  - `import_data.py` — импорт CSV‑данных;
  - `backup_db.sh` / `backup_db.ps1` — резервное копирование.
- `data/` — исходные CSV‑файлы для загрузки стартовых данных.
- `docs/` — сопровождающая документация.

## 2. Условия эксплуатации

### 2.1. Программные требования

- ОС: Windows (по учебным требованиям), допускается Linux/macOS для серверной части.
- Docker и docker-compose для развёртывания.
- PostgreSQL 16 (используется официальный образ `postgres:16`).
 - Python 3.12 (для локального запуска тестов и скриптов).
 - Git (для обновления репозитория).

### 2.2. Аппаратные требования (минимальные)

- CPU: 2 vCPU.
- RAM: 2–4 ГБ.
- Диск: 5–10 ГБ (с учётом объёма резервных копий).
 - Стабильное подключение к сети (для доступа к форме опроса качества).

### 2.3. Требования к персоналу

- базовые навыки работы с Docker и командной строкой;
- понимание принципов работы PostgreSQL и резервного копирования;
- навыки чтения логов и диагностики типовых ошибок.

## 3. Развёртывание и обновление

### 3.1. Первый запуск

1. Скопировать шаблон переменных окружения:

   ```bash
   cp .env.example .env
   ```

2. При необходимости отредактировать `.env`:

   - `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD` — параметры БД;
   - `POSTGRES_HOST`, `POSTGRES_PORT` — хост/порт PostgreSQL;
   - `APP_SECRET_KEY` — секретный ключ сессий;
   - `QUALITY_SURVEY_URL` — URL формы оценки качества.

3. Запуск:

   ```bash
   docker compose up --build
   ```

При первом старте:

- контейнер `db` создаёт базу данных и выполняет `db/init.sql`;
- контейнер `app` поднимает веб‑приложение на порту 8000;
- контейнер `importer` выполняет `scripts/import_data.py` и заполняет справочники.

Интерфейс доступен по адресу: `http://localhost:8000/ui/login`.

### 3.2. Локальный запуск без Docker (для отладки)

1. Установить зависимости:

   ```bash
   pip install -r scripts/requirements.txt
   ```

2. Подготовить переменные окружения в `.env` и запустить PostgreSQL.
3. Запустить приложение:

   ```bash
   uvicorn app.main:app --reload
   ```

### 3.3. Обновление версии приложения

1. Обновить исходный код (git pull).
2. Пересобрать контейнер приложения:

   ```bash
   docker compose build app
   docker compose up -d app
   ```

3. При изменении структуры БД:

- в учебной среде проще удалить volume `db_data` и перезапустить;
- в боевой среде необходимы миграции (в учебном проекте не используются).

### 3.4. Проверка работоспособности

- открыть `/health` и убедиться, что возвращается `ok`;
- войти под тестовыми пользователями из `data/import/inputDataUsers.csv`.

## 4. Структура БД и ролевая модель

Основные таблицы:

- `user_role` — роли пользователей;
- `app_user` — пользователи, связанные с ролями;
- `request_status` — статусы заявок (`is_final` — признак финального статуса);
- `equipment_type`, `equipment_model` — справочники оборудования;
- `issue_type` — типы неисправностей;
- `repair_request` — заявки (даты, оборудование, исполнитель, заказчик);
- `request_comment` — комментарии специалистов;
- `help_request` — запросы помощи от мастеров к менеджеру по качеству.

Ролевая модель (основные права):

- **Менеджер**: полный доступ к заявкам, пользователям и статистике.
- **Оператор**: работа с заявками без управления пользователями.
- **Мастер/Специалист**: видит и редактирует свои заявки, добавляет комментарии.
- **Заказчик**: создаёт и отслеживает свои заявки.
- **Менеджер по качеству**:
  - просматривает все заявки;
  - обрабатывает запросы помощи;
  - может продлевать срок выполнения заявки;
  - может назначать/переназначать мастера.

## 5. Настройка эксплуатации

### 5.1. Переменные окружения

Основные переменные в `.env`:

- `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`;
- `POSTGRES_HOST`, `POSTGRES_PORT`;
- `APP_SECRET_KEY`;
- `QUALITY_SURVEY_URL`.

### 5.2. Импорт данных

Начальные данные берутся из CSV:

- `data/import/inputDataUsers.csv`;
- `data/import/inputDataRequests.csv`;
- `data/import/inputDataComments.csv`.

Импорт выполняется контейнером `importer` через скрипт `scripts/import_data.py`.

### 5.3. Добавление новых пользователей

1. Добавить запись в `inputDataUsers.csv` и пересоздать БД
   (в учебной среде допускается пересоздание volume).
2. Либо создать пользователя через UI (раздел «Пользователи»).

## 6. Запросы помощи и контроль качества

### 6.1. Запрос помощи

Маршрут создания: `GET/POST /ui/requests/{request_id}/help/...`.

Алгоритм:

1. Мастер открывает карточку своей заявки.
2. Нажимает «Запросить помощь» и описывает проблему.
3. В БД создаётся запись в `help_request` со статусом `open`.

### 6.2. Рабочее место менеджера по качеству

Маршрут: `GET /ui/quality`.

На экране отображаются:

- список открытых запросов помощи;
- перечень просроченных заявок (по `due_date`).

Менеджер по качеству может:

- назначить нового исполнителя;
- продлить срок выполнения заявки;
- закрыть запрос помощи с фиксацией результата.

### 6.3. QR‑код для оценки качества

Маршрут: `GET /ui/requests/{request_id}/qr`.

Алгоритм:

1. Проверить наличие аутентифицированного пользователя.
2. Проверить, что заявка существует.
3. Сформировать URL опроса через `services.build_quality_survey_url`.
4. Сгенерировать QR‑код и вернуть PNG.

QR‑код отображается в карточке заявки и ведёт на Google‑форму
для оценки качества работ.

## 7. Резервное копирование и восстановление

Скрипты:

- `scripts/backup_db.sh` — для Linux/macOS;
- `scripts/backup_db.ps1` — для Windows PowerShell.

Запуск:

```bash
./scripts/backup_db.sh
```

В результате создаётся дамп БД в каталоге `backups/`.

Для восстановления используется `pg_restore`.

## 8. Диагностика и типовые ошибки

### 8.1. Приложение не запускается

- проверить наличие `.env` и корректность параметров подключения к БД;
- убедиться, что контейнер `db` запущен (`docker ps`);
- посмотреть логи: `docker compose logs app`.

### 8.2. Ошибки при импорте данных

- проверить формат CSV (разделитель `;` и кодировка UTF‑8);
- убедиться, что роли в `inputDataUsers.csv` совпадают с `user_role`;
- проверить логи `importer`.

### 8.3. Не генерируется QR‑код

- проверить доступность библиотеки `qrcode[pil]`;
- убедиться, что задан `QUALITY_SURVEY_URL` или используется URL по умолчанию;
- проверить, что заявка существует и пользователь авторизован.

## 9. Журналирование и поддержка

Логи приложения пишутся в stdout контейнера `app`.
Для диагностики используйте:

```bash
docker compose logs --tail=200 app
```

При передаче инцидента фиксируйте:

- версию контейнера (git‑коммит);
- точное время ошибки;
- статус и идентификатор заявки;
- пользователя и его роль.
