# Задание 2. ERD, 3НФ, БД, импорт, отчеты, backup, доступ

## 1) ER-диаграмма и 3НФ

### 1.1. Сущности

- `user_role` — роли пользователей.
- `app_user` — пользователи системы.
- `request_status` — статусы заявок.
- `equipment_type` — тип оборудования.
- `equipment_model` — модель оборудования.
- `issue_type` — тип неисправности.
- `repair_request` — заявка на ремонт.
- `request_comment` — комментарии мастеров.
- `spare_part`, `request_spare_part` — нормализованные запчасти.
- `help_request` — запросы помощи.

### 1.2. Нормализация до 3НФ

- Повторяющиеся значения вынесены в справочники (`equipment_type`, `issue_type`,
  `request_status`, `user_role`).
- В `repair_request` хранятся только атрибуты заявки и ссылки на справочники.
- Запчасти вынесены в отдельные сущности (`spare_part`, `request_spare_part`).

Таким образом устранены транзитивные зависимости, данные приведены к 3НФ.

### 1.3. ERD

ER‑диаграмма описана в `docs/er_diagram.mmd` (Mermaid).

## 2) Ссылочная целостность и ограничения

Реализация — `db/init.sql`.

### 2.1. Первичные и внешние ключи

- PK во всех таблицах (`id SERIAL PRIMARY KEY`).
- FK для справочников и связей заявок/комментариев/запчастей/запросов помощи.

### 2.2. Уникальности и проверки данных

- Уникальные поля: `user_role.name`, `request_status.name`, `equipment_type.name`,
  `issue_type.name`, `app_user.login`, `equipment_model(equipment_type_id, name)`.
- Проверки дат:
  - `completion_date >= start_date`;
  - `due_date >= start_date`.

### 2.3. Триггеры

- Проверка ролей клиента/исполнителя в заявке.
- Автозаполнение `completion_date` при финальном статусе.
- Проверка роли мастера в комментариях.
- Проверка ролей в `help_request`.

### 2.4. Индексы

Созданы индексы по статусам, типам оборудования, исполнителям и датам.

## 3) Создание БД и таблиц

При первом старте PostgreSQL в Docker выполняется `db/init.sql`.

```bash
cp .env.example .env
docker compose up --build
```

## 4) Импорт данных

Каталог `data/import/`:

- `inputDataUsers.csv` — пользователи;
- `inputDataRequests.csv` — заявки;
- `inputDataComments.csv` — комментарии.

Импорт выполняется скриптом `scripts/import_data.py`:

- создает справочники;
- импортирует пользователей (пароли хэшируются);
- импортирует заявки и комментарии.

## 5) Отчеты

SQL‑отчеты в `db/reports.sql`, примеры:

- заявки по статусам;
- активные заявки с исполнителями;
- просроченные заявки.

## 6) Резервное копирование

Скрипты:

- `scripts/backup_db.sh` (Linux/macOS);
- `scripts/backup_db.ps1` (Windows).

Дамп создается в `backups/`.

## 7) Разграничение доступа

Пример разграничения доступа представлен в `db/security.sql`.
