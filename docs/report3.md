# Задание 3. Модификация: менеджер по качеству, запросы помощи, QR‑код

## 1. Цель

Дополнить модуль учета заявок:

- добавить роль менеджера по качеству;
- реализовать запросы помощи от мастеров;
- добавить продление сроков и назначение исполнителя;
- реализовать QR‑код для оценки качества работ.

## 2. Ролевая модель

Роль **Менеджер по качеству** имеет права:

- видеть все заявки;
- обрабатывать запросы помощи;
- продлевать срок выполнения заявки;
- назначать/переназначать мастера.

Права реализованы в `app/rbac.py` и проверяются в `app/usecases.py`.

## 3. Запросы помощи

### 3.1. Структура данных

Таблица `help_request` содержит:

- `request_id` — ссылка на заявку;
- `created_by_master_id` — инициатор запроса;
- `quality_manager_id` — обработавший менеджер;
- `assigned_master_id` — назначенный исполнитель;
- `status` (open/closed), `message`, `resolution_note`, `proposed_due_date`.

### 3.2. Сценарий

1. Мастер открывает карточку своей заявки.
2. Нажимает «Запросить помощь» и описывает проблему.
3. Создается запись `help_request` со статусом `open`.
4. Менеджер по качеству открывает `/ui/quality` и видит запрос.
5. При обработке он может:
   - назначить другого мастера;
   - продлить срок выполнения;
   - оставить комментарий и закрыть запрос.

## 4. Контроль качества и QR‑код

В карточке заявки (`request_view.html`) отображается QR‑код.

Маршрут генерации:

- `GET /ui/requests/{request_id}/qr`

QR‑код ведет на Google‑форму с оценкой качества.
Ссылка задается через `QUALITY_SURVEY_URL` (если не задана — используется базовая).

## 5. Изменения интерфейса

Добавлены страницы:

- `/ui/requests/{id}/help/new` — форма запроса помощи;
- `/ui/quality` — рабочее место менеджера по качеству;
- `/ui/help/{id}` — просмотр и закрытие запроса помощи.

## 6. Проверка корректности

- запрет повторного открытого запроса помощи по одной заявке;
- проверка прав на создание и закрытие запроса;
- проверка корректности продления сроков.

## 7. Итог

Функциональность соответствует требованиям дополнения:

- менеджер по качеству включен в процесс;
- мастера могут инициировать запросы помощи;
- контроль качества реализован через QR‑код.
